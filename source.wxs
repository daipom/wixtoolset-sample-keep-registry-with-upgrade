<?xml version='1.0'?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi" xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">
  <Product Id="*" Name="SampleApp" Language="1033" Version="1.0.0.0" Manufacturer="MyCompany" UpgradeCode="3cc427cc-2e65-4f69-8599-3203ac4db3d4">
    <Package InstallerVersion="200" InstallPrivileges="elevated" Compressed="yes" InstallScope="perMachine" />
    <Media Id="1" Cabinet="Project.cab" EmbedCab="yes" CompressionLevel="high" />
    <MajorUpgrade DowngradeErrorMessage="DowngradeErrorMessage" />

    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="WINDOWSVOLUME">
        <Directory Id="OPTLOCATION" Name="opt">
          <Directory Id="PROJECTLOCATION" Name="sampleapp">
            <Component Id="MainExecutable" Guid="29d874e5-87b5-497b-bf91-e8c6eecf9e5b">
              <File Source="files/service.rb" KeyPath="yes" />
              <ServiceControl Id="ServiceControlTestService" Name="testservice" Stop="uninstall" Remove="uninstall" />
            </Component>
            <Component Id="RegisterScript" Guid="fab88be1-1ede-4bde-a6f0-e74dd122e915">
              <File Source="files/register.rb" KeyPath="yes" />
            </Component>
          </Directory>
        </Directory>
      </Directory>
    </Directory>

    <Property Id="REGISTRY_START_OLD">
        <RegistrySearch Id="RegistrySearchStart" Root="HKLM" Key="System\CurrentControlSet\Services\testservice" Name="Start" Type="raw" />
    </Property>
    <Property Id="REGISTRY_DELAYEDAUTOSTART_OLD">
        <RegistrySearch Id="RegistrySearchDelayedAutostart" Root="HKLM" Key="System\CurrentControlSet\Services\testservice" Name="DelayedAutostart" Type="raw" />
    </Property>
    <Property Id="REGISTRY_OPTION_OLD">
        <RegistrySearch Id="RegistrySearchOption" Root="HKLM" Key="System\CurrentControlSet\Services\testservice" Name="Option" Type="raw" />
    </Property>

    <ComponentGroup Id="ProductComponents" Directory="PROJECTLOCATION">
      <!-- TODO Since these integer(DWORD) values have '#' prefix, we cannot write it as is -->
      <!-- <Component Id="SetRegistryStart">
        <Condition><![CDATA[REGISTRY_START_OLD<>""]]></Condition>
        <RegistryValue Id="RegistryValueStart" Root="HKLM" Key="System\CurrentControlSet\Services\testservice" Name="Start" Value="[REGISTRY_START_OLD]" Type="integer" KeyPath="yes" />
      </Component>
      <Component Id="SetRegistryDelayedAutostart">
        <Condition><![CDATA[REGISTRY_DELAYEDAUTOSTART_OLD<>""]]></Condition>
        <RegistryValue Id="RegistryValueDelayedAutostart" Root="HKLM" Key="System\CurrentControlSet\Services\testservice" Name="DelayedAutostart" Value="[REGISTRY_DELAYEDAUTOSTART_OLD]" Type="integer" KeyPath="yes" />
      </Component> -->
      <Component Id="SetRegistryOption">
        <Condition><![CDATA[REGISTRY_OPTION_OLD<>""]]></Condition>
        <RegistryValue Id="RegistryValueOption" Root="HKLM" Key="System\CurrentControlSet\Services\testservice" Name="Option" Value="[REGISTRY_OPTION_OLD]" Type="string" KeyPath="yes" />
      </Component>
    </ComponentGroup>

    <Feature Id="DefaultFeature" Level="1">
      <ComponentRef Id="RegisterScript" />
      <ComponentRef Id="MainExecutable" />
      <!-- <ComponentRef Id="SetRegistryStart" />
      <ComponentRef Id="SetRegistryDelayedAutostart" /> -->
      <ComponentRef Id="SetRegistryOption" />
    </Feature>

    <Property Id="InstallService" Value=" "/>
    <CustomAction Id="SetInstallServiceCommand"
                  Property="InstallService"
                  Value="&quot;C:\Ruby32-x64\bin\ruby.exe&quot; &quot;[PROJECTLOCATION]register.rb&quot;"/>
    <CustomAction Id="InstallService"
                  BinaryKey="WixCA"
                  DllEntry="WixQuietExec64"
                  Execute="deferred"
                  Return="check"
                  Impersonate="no" />

    <InstallExecuteSequence>
      <Custom Action="SetInstallServiceCommand" After="InstallFiles">NOT Installed</Custom>
      <Custom Action="InstallService" After="SetInstallServiceCommand">NOT Installed</Custom>
    </InstallExecuteSequence>
  </Product>
</Wix>
